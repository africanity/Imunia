generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                           String                        @id @default(uuid())
  firstName                    String
  lastName                     String
  email                        String                        @unique
  emailVerified                Boolean                       @default(false)
  pendingEmail                 String?
  emailVerificationCode        String?
  emailVerificationExpiry      DateTime?
  password                     String
  code                         String?
  role                         Role
  agentLevel                   AgentLevel?
  healthCenterId               String?
  isActive                     Boolean                       @default(false)
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt
  activationToken              String?
  activationExpires            DateTime?
  regionId                     String?
  districtId                   String?
  passwordResetAttempts        Int                           @default(0)
  passwordResetCodeExpiry      DateTime?
  appSettingsUpdates           AppSettings[]
  vaccinesCompleted            ChildVaccineCompleted[]       @relation("UserAsAdministered")
  vaccinesEscalated            ChildVaccineOverdue[]         @relation("UserAsEscalated")
  vaccinesScheduled            ChildVaccineScheduled[]       @relation("UserAsScheduler")
  vaccinesScheduledAdministered ChildVaccineScheduled[]      @relation("UserAsScheduledAdministerer")
  childrens                    Children[]
  eventLogs                    EventLog[]
  confirmedTransfers           PendingStockTransfer[]
  records                      Record[]
  stockExpirationNotifications StockExpirationNotification[]
  district                     District?                     @relation(fields: [districtId], references: [id])
  healthCenter                 HealthCenter?                 @relation(fields: [healthCenterId], references: [id])
  region                       Region?                       @relation(fields: [regionId], references: [id])
  userNotifications            UserNotification[]
  scheduledVaccineRequests     VaccineRequest[]              @relation("UserScheduledRequests")
}

model HealthCenter {
  id                String              @id @default(uuid())
  name              String
  address           String
  districtId        String
  childrens         Children[]
  district          District            @relation(fields: [districtId], references: [id])
  records           Record[]
  stockHEALTHCENTER StockHEALTHCENTER[]
  users             User[]
}

model Region {
  id            String          @id @default(uuid())
  name          String
  campaigns     Campaign[]
  communes      Commune[]
  stockREGIONAL StockREGIONAL[]
  users         User[]
}

model Campaign {
  id          String   @id @default(uuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  regionId    String
  medias      Json     @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  region      Region   @relation(fields: [regionId], references: [id], onDelete: Cascade)
}

model VaccineCalendar {
  id               String                  @id @default(uuid())
  description      String
  specificAge      Int
  minAge           Int
  maxAge           Int
  ageUnit          AgeUnit
  completedEntries ChildVaccineCompleted[]
  dueEntries       ChildVaccineDue[]
  lateEntries      ChildVaccineLate[]
  overdueEntries   ChildVaccineOverdue[]
  scheduledEntries ChildVaccineScheduled[]
  doseAssignments  VaccineCalendarDose[]
  vaccineRequests  VaccineRequest[]
}

model Vaccine {
  id                    String                  @id @default(uuid())
  name                  String
  description           String
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  dosesRequired         String
  gender                Gender?
  completedByChildren   ChildVaccineCompleted[]
  dueForChildren        ChildVaccineDue[]
  lateForChildren       ChildVaccineLate[]
  overdueForChildren    ChildVaccineOverdue[]
  scheduledForChildren  ChildVaccineScheduled[]
  childrens             Children[]
  pendingStockTransfers PendingStockTransfer[]
  records               Record[]
  StockDISTRICT         StockDISTRICT[]
  StockHEALTHCENTER     StockHEALTHCENTER[]
  stockLots             StockLot[]
  StockNATIONAL         StockNATIONAL?
  StockREGIONAL         StockREGIONAL[]
  stockTransfers        StockTransfer[]
  calendarAssignments   VaccineCalendarDose[]
  vaccineRequests       VaccineRequest[]
}

model VaccineCalendarDose {
  id         String          @id @default(uuid())
  vaccineId  String
  calendarId String
  doseNumber Int
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  calendar   VaccineCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  vaccine    Vaccine         @relation(fields: [vaccineId], references: [id], onDelete: Cascade)

  @@unique([vaccineId, doseNumber])
  @@index([calendarId])
}

model Commune {
  id        String     @id @default(uuid())
  name      String
  regionId  String
  region    Region     @relation(fields: [regionId], references: [id])
  districts District[]
}

model District {
  id            String          @id @default(uuid())
  name          String
  communeId     String
  commune       Commune         @relation(fields: [communeId], references: [id])
  healthCenters HealthCenter[]
  stockDISTRICT StockDISTRICT[]
  users         User[]
}

model StockNATIONAL {
  id        String  @id @default(uuid())
  vaccineId String  @unique
  quantity  Int?
  vaccine   Vaccine @relation(fields: [vaccineId], references: [id])
}

model StockREGIONAL {
  id        String  @id @default(uuid())
  vaccineId String
  quantity  Int?    @default(0)
  regionId  String
  region    Region  @relation(fields: [regionId], references: [id])
  vaccine   Vaccine @relation(fields: [vaccineId], references: [id])

  @@unique([vaccineId, regionId])
}

model StockDISTRICT {
  id         String   @id @default(uuid())
  vaccineId  String
  quantity   Int?
  districtId String
  district   District @relation(fields: [districtId], references: [id])
  vaccine    Vaccine  @relation(fields: [vaccineId], references: [id])

  @@unique([vaccineId, districtId])
}

model StockHEALTHCENTER {
  id             String       @id @default(uuid())
  vaccineId      String
  quantity       Int?
  healthCenterId String
  healthCenter   HealthCenter @relation(fields: [healthCenterId], references: [id])
  vaccine        Vaccine      @relation(fields: [vaccineId], references: [id])

  @@unique([vaccineId, healthCenterId])
}

model Children {
  id                       String                    @id @default(uuid())
  firstName                String
  lastName                 String
  birthDate                DateTime
  birthPlace               String
  gender                   Gender
  address                  String
  healthCenterId           String
  status                   Status
  passwordParent           String                    @default("0000")
  code                     String?
  phoneParent              String
  fatherName               String?
  motherName               String?
  nextVaccineId            String?
  nextAgentId              String?
  nextAppointment          DateTime?
  isActive                 Boolean                   @default(false)
  photosRequested          Boolean                   @default(false)
  appointmentNotifications AppointmentNotification[]
  vaccinationProofs        ChildVaccinationProof[]
  completedVaccines        ChildVaccineCompleted[]
  dueVaccines              ChildVaccineDue[]
  lateVaccines             ChildVaccineLate[]
  overdueVaccines          ChildVaccineOverdue[]
  scheduledVaccines        ChildVaccineScheduled[]
  healthCenter             HealthCenter              @relation(fields: [healthCenterId], references: [id])
  user                     User?                     @relation(fields: [nextAgentId], references: [id])
  vaccine                  Vaccine?                  @relation(fields: [nextVaccineId], references: [id])
  notifications            Notification[]
  records                  Record[]
  vaccineRequests          VaccineRequest[]
}

model Record {
  id             String       @id @default(uuid())
  healthCenterId String
  vaccineId      String
  agentId        String
  childrenId     String
  user           User         @relation(fields: [agentId], references: [id])
  children       Children     @relation(fields: [childrenId], references: [id])
  healthCenter   HealthCenter @relation(fields: [healthCenterId], references: [id])
  vaccine        Vaccine      @relation(fields: [vaccineId], references: [id])
}

model ChildVaccineCompleted {
  id                String           @id @default(uuid())
  childId           String
  vaccineCalendarId String?
  vaccineId         String
  administeredAt    DateTime         @default(now())
  administeredById  String?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  dose              Int              @default(1)
  administeredBy    User?            @relation("UserAsAdministered", fields: [administeredById], references: [id])
  child             Children         @relation(fields: [childId], references: [id])
  vaccineCalendar   VaccineCalendar? @relation(fields: [vaccineCalendarId], references: [id])
  vaccine           Vaccine          @relation(fields: [vaccineId], references: [id])

  @@unique([childId, vaccineId, dose])
}

model ChildVaccineDue {
  id                String          @id @default(uuid())
  childId           String
  vaccineCalendarId String
  vaccineId         String
  scheduledFor      DateTime
  dose              Int             @default(1)
  child             Children        @relation(fields: [childId], references: [id])
  vaccineCalendar   VaccineCalendar @relation(fields: [vaccineCalendarId], references: [id])
  vaccine           Vaccine         @relation(fields: [vaccineId], references: [id])

  @@unique([childId, vaccineCalendarId, vaccineId, dose])
}

model ChildVaccineScheduled {
  id                String            @id @default(uuid())
  childId           String
  vaccineCalendarId String?
  vaccineId         String
  scheduledFor      DateTime
  plannerId         String?
  administeredById   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  dose              Int               @default(1)
  child             Children          @relation(fields: [childId], references: [id])
  planner           User?             @relation("UserAsScheduler", fields: [plannerId], references: [id])
  administeredBy    User?             @relation("UserAsScheduledAdministerer", fields: [administeredById], references: [id])
  vaccineCalendar   VaccineCalendar?  @relation(fields: [vaccineCalendarId], references: [id])
  vaccine           Vaccine           @relation(fields: [vaccineId], references: [id])
  stockReservation  StockReservation?

  @@unique([childId, vaccineCalendarId, vaccineId, dose])
}

model ChildVaccineOverdue {
  id                String          @id @default(uuid())
  childId           String
  vaccineCalendarId String
  vaccineId         String
  dueDate           DateTime
  escalatedToId     String?
  dose              Int             @default(1)
  child             Children        @relation(fields: [childId], references: [id])
  escalatedTo       User?           @relation("UserAsEscalated", fields: [escalatedToId], references: [id])
  vaccineCalendar   VaccineCalendar @relation(fields: [vaccineCalendarId], references: [id])
  vaccine           Vaccine         @relation(fields: [vaccineId], references: [id])

  @@unique([childId, vaccineCalendarId, vaccineId, dose])
}

model ChildVaccineLate {
  id                String          @id @default(uuid())
  childId           String
  vaccineCalendarId String
  vaccineId         String
  dueDate           DateTime
  detectedAt        DateTime        @default(now())
  dose              Int             @default(1)
  child             Children        @relation(fields: [childId], references: [id])
  vaccineCalendar   VaccineCalendar @relation(fields: [vaccineCalendarId], references: [id])
  vaccine           Vaccine         @relation(fields: [vaccineId], references: [id])

  @@unique([childId, vaccineCalendarId, vaccineId, dose])
}

model Notification {
  id        String   @id @default(uuid())
  childId   String
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  child     Children @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId])
  @@index([isRead])
  @@index([createdAt])
}

model StockLot {
  id                           String                        @id @default(uuid())
  vaccineId                    String
  ownerType                    StockLotOwnerType
  ownerId                      String?
  quantity                     Int
  remainingQuantity            Int
  expiration                   DateTime
  status                       StockLotStatus                @default(VALID)
  sourceLotId                  String?
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt
  pendingTransferId            String?
  pendingTransferLots          PendingStockTransferLot[]
  stockExpirationNotifications StockExpirationNotification[]
  pendingTransfer              PendingStockTransfer?         @relation(fields: [pendingTransferId], references: [id], onDelete: Cascade)
  sourceLot                    StockLot?                     @relation("LotDerivedFrom", fields: [sourceLotId], references: [id])
  derivedLots                  StockLot[]                    @relation("LotDerivedFrom")
  vaccine                      Vaccine                       @relation(fields: [vaccineId], references: [id])
  stockReservations            StockReservation[]
  transferLots                 StockTransferLot[]

  @@index([ownerType, ownerId, vaccineId])
}

model StockTransfer {
  id        String             @id @default(uuid())
  vaccineId String
  fromType  StockLotOwnerType
  fromId    String?
  toType    StockLotOwnerType
  toId      String?
  quantity  Int
  createdAt DateTime           @default(now())
  vaccine   Vaccine            @relation(fields: [vaccineId], references: [id])
  lots      StockTransferLot[]
}

model StockTransferLot {
  id         String        @id @default(uuid())
  transferId String
  lotId      String
  quantity   Int
  lot        StockLot      @relation(fields: [lotId], references: [id])
  transfer   StockTransfer @relation(fields: [transferId], references: [id])
}

model PendingStockTransfer {
  id            String                    @id @default(uuid())
  vaccineId     String
  fromType      StockLotOwnerType
  fromId        String?
  toType        StockLotOwnerType
  toId          String?
  quantity      Int
  status        PendingTransferStatus     @default(PENDING)
  createdAt     DateTime                  @default(now())
  confirmedAt   DateTime?
  confirmedById String?
  confirmedBy   User?                     @relation(fields: [confirmedById], references: [id])
  vaccine       Vaccine                   @relation(fields: [vaccineId], references: [id])
  lots          PendingStockTransferLot[]
  pendingLots   StockLot[]
}

model PendingStockTransferLot {
  id                String               @id @default(uuid())
  pendingTransferId String
  lotId             String
  quantity          Int
  lot               StockLot             @relation(fields: [lotId], references: [id])
  pendingTransfer   PendingStockTransfer @relation(fields: [pendingTransferId], references: [id], onDelete: Cascade)
}

model StockReservation {
  id         String                @id @default(uuid())
  stockLotId String
  scheduleId String                @unique
  quantity   Int                   @default(1)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  schedule   ChildVaccineScheduled @relation(fields: [scheduleId], references: [id])
  stockLot   StockLot              @relation(fields: [stockLotId], references: [id])
}

model StockTransferHistory {
  id              String            @id @default(uuid())
  vaccineId       String
  vaccineName     String
  fromType        StockLotOwnerType
  fromId          String?
  fromName        String?
  toType          StockLotOwnerType
  toId            String?
  toName          String?
  quantity        Int
  sentAt          DateTime
  confirmedAt     DateTime?
  confirmedById   String?
  confirmedByName String?
  lotExpiration   DateTime?
  lotStatus       String?
  createdAt       DateTime          @default(now())
  status          String            @default("CONFIRMED")

  @@index([fromType, fromId])
  @@index([toType, toId])
  @@index([vaccineId])
  @@index([confirmedAt])
  @@index([sentAt])
}

model Advice {
  id          String   @id @default(uuid())
  title       String
  content     String
  category    String?
  ageUnit     AgeUnit?
  minAge      Int?
  maxAge      Int?
  specificAge Int?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model VaccineRequest {
  id                String           @id @default(uuid())
  childId           String
  vaccineId         String
  vaccineCalendarId String?
  dose              Int              @default(1)
  status            String           @default("PENDING")
  requestedAt       DateTime         @default(now())
  scheduledFor      DateTime?
  scheduledById     String?
  appointmentId     String?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  child             Children         @relation(fields: [childId], references: [id])
  scheduledBy       User?            @relation("UserScheduledRequests", fields: [scheduledById], references: [id])
  vaccineCalendar   VaccineCalendar? @relation(fields: [vaccineCalendarId], references: [id])
  vaccine           Vaccine          @relation(fields: [vaccineId], references: [id])

  @@index([childId])
  @@index([status])
  @@index([requestedAt])
  @@index([scheduledById])
}

model ChildVaccinationProof {
  id         String   @id @default(uuid())
  childId    String
  filePath   String
  fileName   String
  fileSize   Int?
  mimeType   String?
  uploadedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  title      String
  uploadedBy String?
  child      Children @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId])
  @@index([uploadedAt])
}

model StockExpirationNotification {
  id                   String   @id @default(uuid())
  stockLotId           String
  userId               String
  notifiedAt           DateTime @default(now())
  expirationDate       DateTime
  daysBeforeExpiration Int
  notificationType     String
  stockLot             StockLot @relation(fields: [stockLotId], references: [id], onDelete: Cascade)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([stockLotId, userId, notificationType])
  @@index([notifiedAt])
  @@index([expirationDate])
}

model AppointmentNotification {
  id                 String   @id @default(uuid())
  childId            String
  scheduledVaccineId String?
  appointmentDate    DateTime
  notificationType   String
  notifiedAt         DateTime @default(now())
  sentVia            String
  child              Children @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([childId, notificationType, appointmentDate])
  @@index([appointmentDate])
  @@index([notifiedAt])
  @@index([childId])
  @@index([scheduledVaccineId])
}

model AppSettings {
  id          String   @id @unique @default(uuid())
  appName     String?
  logoPath    String?
  updatedAt   DateTime @updatedAt
  updatedById String?
  updatedBy   User?    @relation(fields: [updatedById], references: [id])
}

model UserNotification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model EventLog {
  id            String   @id @default(uuid())
  type          String
  subtype       String?
  action        String
  userId        String?
  userFirstName String?
  userLastName  String?
  userEmail     String?
  userRole      String?
  entityType    String?
  entityId      String?
  entityName    String?
  details       Json?
  metadata      Json?
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [userId], references: [id])

  @@index([type, subtype])
  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@index([entityType, entityId])
}

enum Role {
  NATIONAL
  REGIONAL
  DISTRICT
  AGENT
  SUPERADMIN
}

enum AgentLevel {
  ADMIN
  STAFF
}

enum AgeUnit {
  WEEKS
  MONTHS
  YEARS
}

enum Gender {
  M
  F
}

enum Status {
  A_JOUR
  PAS_A_JOUR
}

enum StockLotOwnerType {
  NATIONAL
  REGIONAL
  DISTRICT
  HEALTHCENTER
}

enum StockLotStatus {
  VALID
  EXPIRED
  PENDING
}

enum PendingTransferStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

